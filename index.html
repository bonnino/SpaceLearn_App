<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous">
    </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Flashcards</title>
  <style>
    body {
      padding: 1rem;
      font-size: 1.2rem;
      background-color: #f0f4c3;
      /* Vert pastel */
    }

    .study-section {
      margin-top: 3rem;
      margin-bottom: 3rem;
    }

    .flashcard-container {
      border: 1px solid #ccc;
      padding: 3rem;
      //margin-bottom: 3rem;
      border-radius: 10px;
      background-color: #f9f9f9;
    }

    .flashcard-content {
      min-height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      //margin-bottom: 3rem;
    }

    .flashcard-controls {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    #prev-card-btn,
    #next-card-btn {
      padding: 0.75rem 1rem;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
    }

    #prev-card-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    #category-selection {
      margin-bottom: 3rem;
    }

    .show-answer-btn {
      margin-top: 2rem;
      padding: 0.75rem 1rem;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .show-answer-btn:hover {
      background-color: #367c39;
    }

    .flashcard {
      position: relative;
      perspective: 1000px;
      width: 100%;
      /* height: auto;  Enlever la hauteur auto pour pouvoir la fixer */
      height: 200px;
      /* Ajout d'une hauteur fixe */
      min-height: 200px;
      /* Garder min-height pour assurer une hauteur minimale */
      transition: transform 0.6s;
      transform-style: preserve-3d;
      cursor: pointer;
    }

    .flashcard.flipped {
      transform: rotateY(180deg);
    }

    .flashcard .front,
    .flashcard .back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      display: flex;
      align-items: top;
      justify-content: center;
      border-radius: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      padding: 1rem;
    }

    .flashcard .front {
      background-color: #f9f9f9;
      color: #2c3e50;
    }

    .flashcard .back {
      background-color: #82e0aa;
      color: #1a5235;
    }

    .flashcard .front.fade-out {
      opacity: 0;
    }

    .flashcard .back.fade-in {
      opacity: 1;
    }

    .btn-lg {
      font-size: 1.2rem;
      padding: 0.75rem 0.5rem;
    }

    .form-select {
      font-size: 1.2rem;
      padding: 0.75rem;
    }

    @media screen and (max-width: 600px) {
      body {
        font-size: 1rem;
      }

      .flashcard-content {
        font-size: 1.3rem;
      }

      #prev-card-btn,
      #next-card-btn,
      .show-answer-btn,
      .btn-lg,
      .form-select {
        font-size: 1rem;
      }

      .flashcard .front,
      .flashcard .back {
        font-size: 1.3rem;
      }
    }
  </style>
</head>

<body>
  <!--
     --- PARTIE FIXE ---
  -->
  <div class="container">
    <h1 class="mt-4">Quiz Flashcards</h1>
    <div id="category-selection">
      <h2>Choisir une catégorie :</h2>
      <select id="category-list" class="form-select form-select-lg">
        <option value="-1">Sélectionner une catégorie</option>
      </select>
    </div>
    <div id="study-section" class="study-section"></div>
    <div id="study-card-number" class="text-center mb-3 h4">Carte : / </div>
    <div id="flashcard-container" class="flashcard-container">
      <div id="sens-controls" class="mb-3">
        <label class="me-2 h4">
          <input type="radio" name="sens" value="QtoR" checked> Question -> Réponse
        </label>
        <label class="h4">
          <input type="radio" name="sens" value="RtoQ"> Réponse -> Question
        </label>
      </div>
      <div id="flashcard-content" class="flashcard-content">
      </div>
    </div>
    <div id="flashcard-controls" class="flashcard-controls">
      <button id="prev-card-btn" class="btn btn-secondary btn-lg" onclick="prevFlashcard()" disabled>
        <i class="fas fa-chevron-left"></i> <span class="visually-hidden">Carte précédente</span>
      </button>
      <button id="next-card-btn" class="btn btn-primary btn-lg" onclick="nextFlashcard()">
        <span class="visually-hidden">Carte suivante</span> <i class="fas fa-chevron-right"></i>
      </button>
      </button>
      <button class="btn btn-success btn-lg" onclick="promouvoirCarte(flashcardsData[currentCardIndex].rowNumber)">
        <i class="fa-solid fa-thumbs-up"></i> <span class="visually-hidden">Je le savais</span>
      </button>
      <button class="btn btn-danger btn-lg" onclick="retrograderCarte(flashcardsData[currentCardIndex].rowNumber)">
        <i class="fa-solid fa-thumbs-down"></i> <span class="visually-hidden">Je ne le savais pas</span>
      </button>      
      <button id="next-card-btn" class="btn btn-primary btn-lg" onclick="copierDansPressePapier()">
        <span class="visually-hidden">Copier dans presse-papier</span> <i class="fas fa-clipboard"></i>
      </button>
    </div>
  </div>
  <!-- 
   --- PARTIE DYNAMIQUE ---
  -->
  <script>
    let flashcardsData;
    let G_boites; 
    let currentBoiteId = -1 ;
    let currentCardIndex = 0;
    let currentCategoryId = -1;

    // Déclaration des éléments DOM pour les : catégories, boites, flashcards
    const categorySelection = document.getElementById('category-selection'); // Récupère l'élément ici
    const categoryList = document.getElementById('category-list');
    const studySection = document.getElementById('study-section'); // Assure-toi d'avoir un élément avec cet ID
    const cardNumberDisplay = document.getElementById('study-card-number'); // Récupère l'élément pour afficher le nombre

    const flashcardContainer = document.getElementById('flashcard-container');
    const sensControls = document.getElementById('sens-controls'); // Récupère le conteneur des radios
    const flashcardContent = document.getElementById('flashcard-content');

    const prevCardBtn = document.getElementById('prev-card-btn');
    const nextCardBtn = document.getElementById('next-card-btn');

    // Charge les données au chargement de la page
    document.addEventListener('DOMContentLoaded', onLoad);

    // Fonction appelée au chargement de la page
    function onLoad() {
      google.script.run.withSuccessHandler(handleCategories).getCategories();
      google.script.run.withSuccessHandler(handleBoites).getBoites();
      const sensControls = document.getElementById('sens-controls');
      if (sensControls) {
        sensControls.addEventListener('change', () => {
          showFlashcard(currentCardIndex);
        });
      }
    }

    // Fonction pour afficher les flashcards
    function displayFlashcards(data) {
      console.log("displayFlashcards appelée avec les données :", data);
      flashcardsData = data;
      showFlashcard(currentCardIndex);
      // nombre total de cartes de la boite
      cardNumberDisplay.textContent =  `Carte : ${currentCardIndex + 1}/${flashcardsData.length} (boite : ${G_boites[currentBoiteId].Nom})`;
      // gestion des boutons
      if (currentCardIndex > 0) {
        prevCardBtn.disabled = false;
      } else {
        prevCardBtn.disabled = true;
      }
      if (currentCardIndex < flashcardsData.length - 1) {
        nextCardBtn.disabled = false;
      } else {
        nextCardBtn.disabled = true;
      }

      flashcardContainer.style.display = 'block';
    }

    // Stockage des categories

    function handleCategories(categories) {
      if (categoryList) {
        categories.forEach(categorie => {
          const option = document.createElement('option');
          option.value = categorie.Id;
          option.textContent = categorie.Nom.trim();
          categoryList.appendChild(option);
        });

        categoryList.addEventListener('change', () => {
          const selectedCategoryId = categoryList.value;
          if (selectedCategoryId !== "-1") {
            console.log(`Catégorie sélectionnée (ID: ${selectedCategoryId}) !`);
            //currentCategoryId = selectedCategoryId;
            currentCategoryId = parseInt(selectedCategoryId);
            studySection.style.display = 'block'; // Affiche la section des boîtes
          } else {
            studySection.style.display = 'none'; // Cache la section des boîtes si aucune catégorie n'est sélectionnée
            flashcardContainer.style.display = 'none'; // Cache le conteneur des flashcards
          }
        });
      } else {
        console.error("L'élément category-list n'a pas été trouvé dans le HTML.");
      }

      // Cache initialement la section des flashcards
      //studySection.style.display = 'none';
      flashcardContainer.style.display = 'none';
    }

    // stockage des boites 

    function handleBoites(boites) {
      if (studySection) {
        G_boites = {};
        boites.forEach(boite => {

          const nomBoite = boite.Nom;
          const idBoite = boite.Id;
          const button = document.createElement('button');
          button.className = 'btn btn-primary btn-lg';
          button.textContent = nomBoite.trim();
          button.style.marginBottom = '10px';
          button.style.marginRight = '10px';
          button.dataset.boiteId = idBoite;

          // on stocke les boitesdans le contexte de la page
          G_boites[idBoite] = boite; // On utilise l'ID comme clé


          button.addEventListener('click', () => {
            console.log(`Bouton ${nomBoite.trim()} (ID: ${idBoite}) cliqué !`);
            console.log("currentCategoryId au moment du clic :", currentCategoryId);
            // on stocke la boite en cours dans le contexte de la page
            currentBoiteId = idBoite ;
            currentCardIndex = 0;
            console.log(`Id Boite : ${currentBoiteId}`);
            console.log(`Nom Boite : ${G_boites[currentBoiteId].Nom}`);
            google.script.run
              .withSuccessHandler(function (flashcards) {
                console.log("Données reçues de getFlashcardsForBoiteAndCategory :", flashcards);
                displayFlashcards(flashcards);
              })
              .getFlashcardsForBoiteAndCategory(idBoite, currentCategoryId);
            /*
                  google.script.run
            .withSuccessHandler(displayFlashcards)
            .getFlashcardsForBoiteAndCategory(idBoite, currentCategoryId);*/
            console.log("Appel à google.script.run effectué.");
          });
          studySection.appendChild(button);
        });
      }
    }


    // Fonction pour afficher une flashcard spécifique
    function showFlashcard(index) {
      console.log(`showFlashcard : index=${index}`)

      console.log("Contenu de flashcardsData dans showFlashcard :", flashcardsData);
      flashcardContent.innerHTML = '';

      if (index < flashcardsData.length) {
        const cardData = flashcardsData[index];
        console.log(`rowNumber=${cardData.rowNumber}`); // affichage du vrai numéro de ligne

        // Incrémente le compteur d'affichages en utilisant le numéro de ligne
        if (cardData.rowNumber) {
          google.script.run.updateCardStats(cardData.rowNumber);
        }

        const selectedSens = sensControls.querySelector('input[name="sens"]:checked').value;
        const afficheQuestionEnPremier = selectedSens === 'QtoR';


        const questionText = afficheQuestionEnPremier ? cardData.Question : cardData.Reponse;
        const reponseText = afficheQuestionEnPremier ? cardData.Reponse : cardData.Question;

        const flashcardDiv = document.createElement('div');
        flashcardDiv.classList.add('flashcard');

        const frontDiv = document.createElement('div');
        frontDiv.classList.add('front');
        frontDiv.textContent = questionText;
        frontDiv.style.opacity = '1';
        frontDiv.style.transition = 'opacity 1s ease-in-out';

        const backDiv = document.createElement('div');
        backDiv.classList.add('back', 'answer');
        backDiv.textContent = reponseText;
        backDiv.style.opacity = '0';
        backDiv.style.transition = 'opacity 1s ease-in-out';

        flashcardDiv.appendChild(frontDiv);
        flashcardDiv.appendChild(backDiv);

        const showAnswerBtn = document.createElement('button');
        showAnswerBtn.classList.add('show-answer-btn');
        // Créer l'élément i pour l'icône
        const iconElement = document.createElement('i');
        iconElement.classList.add('fa-solid', 'fa-eye'); // Initialiser avec l'icône "eye"
        showAnswerBtn.appendChild(iconElement); // Ajouter l'icône au bouton

        showAnswerBtn.onclick = () => {
          if (iconElement.classList.contains('fa-eye')) {
            frontDiv.style.opacity = '0';
            backDiv.style.opacity = '1';
            // Changer la classe pour afficher l'icône "eye-slash"
            iconElement.classList.remove('fa-eye');
            iconElement.classList.add('fa-eye-slash');
          } else {
            frontDiv.style.opacity = '1';
            backDiv.style.opacity = '0';
            // Changer la classe pour afficher l'icône "eye"
            iconElement.classList.remove('fa-eye-slash');
            iconElement.classList.add('fa-eye');
          }
        };
        flashcardDiv.appendChild(showAnswerBtn);

        flashcardContent.appendChild(flashcardDiv);
      } else {
        flashcardContent.textContent = 'Vous avez terminé toutes les questions !';
      }
    }

    function nextFlashcard() {
      if (currentCardIndex < flashcardsData.length - 1) {
        currentCardIndex++;
        showFlashcard(currentCardIndex);
        cardNumberDisplay.textContent =  `Carte : ${currentCardIndex + 1}/${flashcardsData.length} (boite : ${G_boites[currentBoiteId].Nom})`;
        prevCardBtn.disabled = false; // Réactive "Précédente" quand on avance
      }
      nextCardBtn.disabled = currentCardIndex === flashcardsData.length - 1; // Désactive "Suivante" à la fin
    }

    function prevFlashcard() {
      if (currentCardIndex > 0) {
        currentCardIndex--;
        showFlashcard(currentCardIndex);
        cardNumberDisplay.textContent =  `Carte : ${currentCardIndex + 1}/${flashcardsData.length} (boite : ${G_boites[currentBoiteId].Nom})`;
        nextCardBtn.disabled = false; // Réactive "Suivante" quand on recule
      }
      prevCardBtn.disabled = currentCardIndex === 0; // Désactive "Précédente" au début
    }

    /*
       --- Promotion et retrogradation
      */
    function promouvoirCarte(rowNumber) {
      console.log("Fonction : promouvoirCarte, Paramètres : rowNumber =", rowNumber);
      google.script.run.withSuccessHandler(handlePromotionSuccess).withFailureHandler(handlePromotionFailure).traiterPromotionCarte(rowNumber,Object.keys(G_boites).length);
    }

    function retrograderCarte(rowNumber) {
      console.log("Fonction : retrograderCarte, Paramètres : rowNumber =", rowNumber);
      google.script.run.withSuccessHandler(handleRetrogradationSuccess).withFailureHandler(handleRetrogradationFailure).traiterRetrogradationCarte(rowNumber);
    }

    function handlePromotionSuccess(result) {
      console.log("Promotion réussie :", result);
      afficherMessage("Carte promue !", "success");
      // Ici, tu peux mettre à jour l'interface utilisateur si nécessaire
    }

    function handlePromotionFailure(error) {
      console.error("Erreur lors de la promotion :", error);
      afficherMessage("Erreur lors de la promotion : " + error, "error");
      // Ici, tu peux afficher un message d'erreur à l'utilisateur
    }

    function handleRetrogradationSuccess(result) {
      console.log("Rétrogradation réussie :", result);
      afficherMessage("Carte rétrogradée !", "info");
      // Ici, tu peux mettre à jour l'interface utilisateur si nécessaire
    }

    function handleRetrogradationFailure(error) {
      console.error("Erreur lors de la rétrogradation :", error);
      afficherMessage("Erreur lors de la rétrogradation : " + error, "error");
      // Ici, tu peux afficher un message d'erreur à l'utilisateur
    }
    // Collage dans le presse-papier
    function copierDansPressePapier() {
      console.log('copierDansPressePapier');
      const selectedSens = sensControls.querySelector('input[name="sens"]:checked').value;
      const afficheQuestionEnPremier = selectedSens === 'QtoR';
      const texte = document.querySelector('.flashcard > .front[style*="opacity: 1"], .flashcard > .back[style*="opacity: 1"]').textContent;
      console.log('Texte a copier  : ', texte);
      if (!navigator.clipboard) {
        // La Clipboard API n'est pas supportée dans ce navigateur (cas rare)
        console.warn("Clipboard API non supportée. Utilisation d'une méthode alternative dépréciée.");
        copierTexteAlternative(texte); // Utiliser une méthode alternative
        return;
      }
      navigator.clipboard.writeText(texte).then(() => {
        console.log('Texte copié dans le presse-papier : ', texte);
        // Vous pouvez ajouter ici un feedback visuel, comme un toast ou un message
        afficherMessage("Texte copié !", "success"); // Utilisez une fonction d'affichage de message
      }).catch(err => {
        console.error('Erreur lors de la copie : ', err);
        afficherMessage("Erreur lors de la copie : " + err, "error"); // Gérez l'erreur
      });
    }


    function afficherMessage(message, type = 'info') {
      // Créer un élément div pour le message
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.style.position = 'fixed'; // Positionnement pour ne pas interférer avec le layout
      messageDiv.style.top = '20px';      // Ajustez la position verticale
      messageDiv.style.left = '50%';
      messageDiv.style.transform = 'translateX(-50%)'; // Centrer horizontalement
      messageDiv.style.backgroundColor = type === 'success' ? '#4CAF50' : (type === 'error' ? '#FF5252' : '#F5B221'); // Vert, Rouge, Orange
      messageDiv.style.color = 'white';
      messageDiv.style.padding = '10px 20px';
      messageDiv.style.borderRadius = '5px';
      messageDiv.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)'; // Ombre pour la visibilité
      messageDiv.style.zIndex = '1000'; // Assurez-vous qu'il est au-dessus des autres éléments
      messageDiv.style.transition = 'opacity 0.5s ease-in-out, transform 0.5s ease-in-out'; // Transition douce
      messageDiv.style.opacity = '0'; // Débuter invisible
      messageDiv.style.transform = 'translate(-50%, -30px)'; // Débuter au dessus

      document.body.appendChild(messageDiv); // Ajouter au DOM

      // Animation d'apparition
      setTimeout(() => {
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateX(-50%)'; // Aller à la position finale
      }, 10); // Un petit délai pour que la transition fonctionne

      // Disparition automatique après 3 secondes (ajustez si nécessaire)
      setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translate(-50%, -30px)';
        setTimeout(() => {
          document.body.removeChild(messageDiv); // Supprimer du DOM après la transition
        }, 500); // Attendre la fin de la transition
      }, 3000);
    }    
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    $(function () {
      $(document).keydown(function (e) {
        if (e.key === "ArrowRight") {
          nextFlashcard();
        } else if (e.key === " ") { // Espace pour afficher la réponse (peut être modifié)
          const answerDiv = document.querySelector('.flashcard .answer');
          if (answerDiv) {
            answerDiv.style.display = 'block';
          }
        }
      });
    });
  </script>
</body>

</html>